generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model Lead {
  id        String   @id @default(cuid())
  name      String
  email     String   @unique
  company   String?
  position  String?
  status    String   @default("NEW")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  outreachStatus String?
  campaignId     String?
  campaign       Campaign?       @relation(fields: [campaignId], references: [id])
  sentEmails     OutboundEmail[]
  replyDrafts    Draft[]          @relation("LeadDrafts")  // ðŸ‘ˆ relation name added

  @@index([status])
  @@index([email])
  @@index([campaignId])
}

model Campaign {
  id          String   @id @default(cuid())
  name        String
  description String?
  context     String?
  reference   String?
  senderName  String?
  status      String   @default("DRAFT")
  createdAt   DateTime @default(now())
  startedAt   DateTime?
  completedAt DateTime?

  leads  Lead[]
  emails OutboundEmail[]
  drafts Draft[]
}

model Draft {
  id        String   @id @default(cuid())
  subject   String
  body      String
  tone      String
  useCase   String
  version   Int      @default(1)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  campaignId String?
  campaign   Campaign? @relation(fields: [campaignId], references: [id])

  // Reply Drafts Relation
  leadId       String?  @map("lead_id")
  lead         Lead?    @relation("LeadDrafts", fields: [leadId], references: [id]) // named relation
  isReplyDraft Boolean  @default(false)

  sentCount  Int @default(0)
  replyCount Int @default(0)

  emails OutboundEmail[]

  @@index([isActive])
  @@index([tone, useCase])
  @@index([campaignId])
  @@index([leadId])
}

model OutboundEmail {
  id         String   @id @default(cuid())
  leadId     String
  lead       Lead     @relation(fields: [leadId], references: [id])
  campaignId String?
  campaign   Campaign? @relation(fields: [campaignId], references: [id])
  draftId    String?
  draft      Draft?    @relation(fields: [draftId], references: [id])
  
  subject    String
  body       String
  sentAt     DateTime @default(now())
  status     String   @default("SENT")
  error      String?

  openedAt  DateTime?
  repliedAt DateTime?
  replyText String?

  // Threading
  replyToId   String?       @map("reply_to_id")
  replyTo     OutboundEmail? @relation("Replies", fields: [replyToId], references: [id])
  replies     OutboundEmail[] @relation("Replies")
  isIncoming  Boolean        @default(false)
  messageId   String?
  references  String?
  inReplyTo   String?
  fromAddress String?
  toAddress   String?

  // Analysis
  sentiment   String?
  intent      String?
  analysis    String?

  @@index([leadId])
  @@index([campaignId])
  @@index([sentAt])
  @@index([messageId])
}